<!DOCTYPE html>
<!-- TreeRadar v5 (Dec 12, 2025) by @spacebanana12 on GitHub -->
<html>
<head>
    <title>TreeRadar</title>
    <link rel="icon" href="https://raw.githubusercontent.com/microsoft/fluentui-emoji/refs/heads/main/assets/Deciduous%20tree/3D/deciduous_tree_3d.png" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css' rel='stylesheet' />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(20, 20, 20, 0.5);
            --glass-border-color: rgba(255, 255, 255, 0.1);
            --glass-border: 1px solid var(--glass-border-color);
            --glass-blur: blur(10px);
            --glass-radius: 10px;
            --glass-hover: rgba(255, 255, 255, 0.2);
            --font-family: 'Outfit', sans-serif;
        }

        body, html {
            margin: 0;
            padding: 0;
            font-family: var(--font-family), -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden; 
            user-select: none; 
            -webkit-user-select: none; 
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .standard-glass,
        #attribution-bubble,
        #pill-menu-btn, 
        #pill-info-btn,
        .sidebar-panel,
        .settings-popup,
        #full-alert-text-popup,
        .alert-popup,
        .map-popup-base,
        .toast-notification {
            background: var(--glass-bg) !important;
            backdrop-filter: var(--glass-blur) !important;
            -webkit-backdrop-filter: var(--glass-blur) !important;
            border: var(--glass-border); 
            color: white !important;
            border-radius: var(--glass-radius) !important;
            font-family: var(--font-family) !important;
            box-shadow: none !important; 
            transition: background 0.2s, border-color 0.2s;
        }

        .sidebar-menu-item:hover, 
        .map-popup-base ul li:hover,
        .settings-item:hover,
        #attribution-bubble:hover,
        #pill-menu-btn:hover,
        #pill-info-btn:hover,
        .sidebar-close-btn:hover,
        .alert-popup:hover {
            background: var(--glass-hover) !important;
            border-color: var(--glass-hover) !important;
            color: white;
            cursor: pointer;
        }

        #pill-menu-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 2000;
            width: 40px;
            height: 40px;
            display: flex;
            padding: 0;
            background: none; 
            border: none;
        }

        #radar-info-pill {
            position: absolute;
            top: 10px;
            left: 60px; 
            z-index: 2000;
            height: 40px;
            display: none; 
            padding: 0;
            width: max-content;
            background: none; 
            border: none;
        }

        #pill-menu-btn {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        #pill-menu-btn .material-symbols-rounded { font-size: 24px; }

        #pill-info-btn {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center; 
            height: 100%;
            padding: 0 15px; 
            text-align: center;
            min-width: 80px; 
        }

        #pill-id-time {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 13px;
            line-height: 1.1;
            white-space: nowrap;
        }

        #pill-product {
            font-family: 'Outfit', sans-serif;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.1;
            white-space: nowrap;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        #alert-popup-container {
            position: fixed;
            bottom: 0; left: 0; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            align-items: flex-start;
            pointer-events: none; 
            padding-bottom: 10px;
        }

        .alert-popup {
            padding: 15px; 
            margin: 10px 10px 0px 10px;
            width: max-content;
            max-width: 50vw;
            opacity: 0;
            transform: translateX(-120%);
            transition: transform 0.5s ease-out, opacity 0.3s ease-out, background 0.2s, border-color 0.2s;
            cursor: pointer; 
            pointer-events: auto; 
        }
        .alert-popup.fly-in { opacity: 1; transform: translateX(0); }
        .alert-popup.fly-out { opacity: 0; transform: translateX(-120%); }
        .alert-popup h4 { margin: 0 0 8px 0; font-size: 18px; }
        .alert-popup p { margin: 2px 0; font-size: 14px; white-space: normal; }

        #sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2001;
            backdrop-filter: blur(2px);
        }

        #sidebar {
            position: fixed;
            top: 0;
            left: -300px; 
            width: 280px;
            height: 100%;
            z-index: 2002;
            transition: left 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border-radius: 0 10px 10px 0 !important; 
            border-left: none !important;
            border-top: none !important;
            border-bottom: none !important;
        }
        #sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .sidebar-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sidebar-close-btn {
            background: none;
            border: 1px solid transparent; 
            color: white;
            cursor: pointer;
            padding: 5px;
            display: flex;
            border-radius: 5px;
            transition: background 0.2s, border-color 0.2s;
        }

        .sidebar-content {
            padding: 10px; 
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 5px; 
        }

        .sidebar-menu-item, .settings-item {
            background: transparent;
            border: 1px solid transparent; 
            color: rgba(255, 255, 255, 0.9);
            width: 100%;
            padding: 12px 15px;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: flex-start; 
            gap: 15px;
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 400;
            cursor: pointer;
            transition: background 0.2s, border-color 0.2s;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .sidebar-item-content {
            display: flex;
            align-items: center;
            gap: 15px;
            text-align: left;
            flex-grow: 1;
        }
        .sidebar-menu-item i, .settings-item i {
            font-size: 22px;
        }
        .dropdown-arrow {
            font-size: 20px;
            transition: transform 0.3s ease;
            margin-left: auto; 
        }
        .sidebar-menu-item.active .dropdown-arrow, .settings-item.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .sidebar-dropdown-container {
            display: none;
            flex-direction: column;
            padding-left: 15px; 
            gap: 5px;
        }
        .sidebar-dropdown-container.show {
            display: flex;
        }
        
        .sidebar-submenu-item {
            padding: 10px 15px;
            font-size: 15px;
        }
        
        .maplibregl-popup-content {
            background: none;
            box-shadow: none;
            padding: 0;
            border-radius: 10px;
        }
        .maplibregl-popup-tip { display: none; }
        .maplibregl-popup-close-button {
            top: 5px;
            right: 5px;
            font-size: 20px;
            z-index: 1;
            color: #ccc;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .map-popup-base { 
            padding: 0; 
            font-size: 14px;
            min-width: 200px; 
            overflow: hidden; 
            touch-action: pan-y; 
        }

        .map-popup-base h4 {
            margin: 0; 
            padding: 12px 10px;
            font-size: 18px;
            text-align: center;
        }
        .map-popup-base .popup-content-area {
            padding: 4px; 
            max-height: 200px; 
            overflow-y: auto; 
            scrollbar-width: thin; 
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }
        .map-popup-base .popup-content-area::-webkit-scrollbar { width: 4px; }
        .map-popup-base .popup-content-area::-webkit-scrollbar-track { background: transparent; }
        .map-popup-base .popup-content-area::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.3); border-radius: 2px; }

        .map-popup-base ul { list-style: none; padding: 0; margin: 0; }
        .map-popup-base ul li {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center; 
            padding: 10px; 
            cursor: pointer;
            user-select: none;
            border-radius: 6px; 
            border: 1px solid transparent; 
            font-size: 14px;
            transition: background 0.2s, border-color 0.2s;
        }
        .map-popup-base ul li button {
            background: none;
            border: none;
            color: inherit; 
            font: inherit; 
            padding: 0;
            margin: 0;
            cursor: pointer;
            width: 100%;
            text-align: center;
            font-size: inherit; 
        }
        .map-popup-base ul li button:focus { outline: none; }
        .map-popup-base .popup-content-area p { margin: 8px 10px; white-space: normal; }
        .map-popup-base .popup-content-area p:first-of-type { margin-top: 10px; }
        .map-popup-base .popup-content-area p:last-of-type { margin-bottom: 10px; }

        .alert-pager {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 30px; 
            border-radius: 0 0 10px 10px;
            padding-bottom: 5px;
        }
        .alert-pager .pager-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3); 
            margin: 0 6px; 
            cursor: pointer;
            transition: all 0.2s ease;
            border: 4px solid transparent; 
            background-clip: padding-box;
            box-sizing: content-box;
        }
        .alert-pager .pager-dot.active {
            background-color: rgba(255, 255, 255, 1); 
            transform: scale(1.2);
        }

        #full-alert-text-popup-overlay, #settings-overlay {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); 
            z-index: 2000; 
            align-items: center;
            justify-content: center;
        }
        #settings-overlay { z-index: 3000; }

        #full-alert-text-popup, .settings-popup {
            padding: 15px; 
            width: 90%;
            max-width: 400px;
            max-height: 80vh; 
            overflow-y: auto; 
            -ms-overflow-style: none;  
            scrollbar-width: none;  
            position: relative; 
            display: flex;
            flex-direction: column;
        }
        
        #full-alert-text-popup::-webkit-scrollbar, .settings-popup::-webkit-scrollbar { display: none; }

        #full-alert-text-popup h4, .settings-popup h4 { margin: 0 0 10px 0; font-size: 24px; text-align: center; }
        #full-alert-text-popup p, #full-alert-text-popup pre, .settings-popup p { margin: 5px 0; font-size: 16px; line-height: 1.4; }
        #full-alert-text-popup pre { white-space: pre-wrap; font-family: inherit; }
        #full-alert-text-popup strong { font-weight: bold; }
        
        .settings-category-header {
            font-size: 12px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.6);
            margin: 15px 0 5px 10px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .settings-splitter {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 0 10px 0;
            width: 100%;
        }
        .settings-content-wrapper { display: flex; flex-direction: column; gap: 5px; }

        .toggle-switch-ui {
            width: 36px; 
            height: 20px; 
            background: rgba(255,255,255,0.2);
            border-radius: 10px; 
            position: relative; 
            transition: background 0.3s;
            flex-shrink: 0;
        }
        .toggle-switch-ui::after {
            content: ''; 
            position: absolute; 
            top: 2px; 
            left: 2px;
            width: 16px; 
            height: 16px; 
            background: white; 
            border-radius: 50%;
            transition: transform 0.3s;
        }
        .toggle-switch-ui.active { background: #4CAF50; }
        .toggle-switch-ui.active::after { transform: translateX(16px); }

        #attribution-bubble {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1002;
            display: flex;
            flex-direction: row-reverse;
            align-items: center;
            justify-content: center;
            height: 30px;
            width: 30px;
            border-radius: 15px !important; 
            box-sizing: border-box;
            cursor: pointer;
            overflow: hidden;
        }
        #attribution-bubble.expanded { width: auto; padding: 0 4px; }
        #attribution-bubble .material-symbols-rounded { font-size: 20px; flex-shrink: 0; }
        #attribution-bubble .attribution-text { display: none; margin-left: 4px; margin-right: 4px; font-size: 14px; white-space: nowrap; }
        #attribution-bubble.expanded .attribution-text { display: block; }
        #attribution-bubble .attribution-text a { color: inherit; text-decoration: none; }
        #attribution-bubble .attribution-text a:hover { text-decoration: underline; }
        
        #toast-container {
            position: fixed;
            bottom: 20px; left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        .toast-notification {
            padding: 8px 16px;
            border-radius: 20px !important;
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        .toast-notification.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="attribution-bubble">
        <i class="material-symbols-rounded">info</i>
        <div class="attribution-text">
            <a href="https://maplibre.org/" target="_blank">MapLibre</a> | <a href="https://carto.com/about-carto/" target="_blank">CARTO</a>, 
            <a href="https://mesonet.agron.iastate.edu/" target="_blank">IEM</a>, 
            <a href="https://noaa.gov/" target="_blank">NOAA/NWS</a>
        </div>
    </div>

    <div id="alert-popup-container"></div>
    <div id="toast-container"></div>

    <div id="pill-menu-container">
        <button id="pill-menu-btn" title="Menu"><i class="material-symbols-rounded">menu</i></button>
    </div>

    <div id="radar-info-pill">
        <button id="pill-info-btn">
            <div id="pill-id-time"></div>
            <div id="pill-product"></div>
        </button>
    </div>

    <div id="sidebar-overlay"></div>

    <div id="sidebar" class="sidebar-panel">
        <div class="sidebar-header">
            <h2><i class="material-symbols-rounded">forest</i> TreeRadar</h2>
            <button id="sidebar-close-btn" class="sidebar-close-btn">
                <i class="material-symbols-rounded">close</i>
            </button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-menu-group">
                <button class="sidebar-menu-item" onclick="toggleSidebarDropdown('outlooks-dropdown', this)">
                    <div class="sidebar-item-content">
                        <i class="material-symbols-rounded">map</i>
                        Outlooks
                    </div>
                    <i class="material-symbols-rounded dropdown-arrow">expand_more</i>
                </button>
                <div id="outlooks-dropdown" class="sidebar-dropdown-container">
                    <button class="sidebar-menu-item sidebar-submenu-item" onclick="toggleSidebarDropdown('day1-dropdown', this)">
                        <div class="sidebar-item-content"><i class="material-symbols-rounded">counter_1</i>Day 1</div>
                        <i class="material-symbols-rounded dropdown-arrow">expand_more</i>
                    </button>
                    <div id="day1-dropdown" class="sidebar-dropdown-container">
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="1" data-type="cat"><i class="material-symbols-rounded">thunderstorm</i>Categorical</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="1" data-type="torn"><i class="material-symbols-rounded">tornado</i>Tornado</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="1" data-type="hail"><i class="material-symbols-rounded">weather_hail</i>Hail</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="1" data-type="wind"><i class="material-symbols-rounded">air</i>Wind</button>
                    </div>
                    
                    <button class="sidebar-menu-item sidebar-submenu-item" onclick="toggleSidebarDropdown('day2-dropdown', this)">
                        <div class="sidebar-item-content"><i class="material-symbols-rounded">counter_2</i>Day 2</div>
                        <i class="material-symbols-rounded dropdown-arrow">expand_more</i>
                    </button>
                    <div id="day2-dropdown" class="sidebar-dropdown-container">
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="2" data-type="cat"><i class="material-symbols-rounded">thunderstorm</i>Categorical</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="2" data-type="torn"><i class="material-symbols-rounded">tornado</i>Tornado</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="2" data-type="hail"><i class="material-symbols-rounded">weather_hail</i>Hail</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="2" data-type="wind"><i class="material-symbols-rounded">air</i>Wind</button>
                    </div>

                    <button class="sidebar-menu-item sidebar-submenu-item" onclick="toggleSidebarDropdown('day3-dropdown', this)">
                        <div class="sidebar-item-content"><i class="material-symbols-rounded">counter_3</i>Day 3</div>
                        <i class="material-symbols-rounded dropdown-arrow">expand_more</i>
                    </button>
                    <div id="day3-dropdown" class="sidebar-dropdown-container">
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="3" data-type="cat"><i class="material-symbols-rounded">thunderstorm</i>Categorical</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="3" data-type="prob"><i class="material-symbols-rounded">percent</i>Probabilistic</button>
                    </div>

                    <button class="sidebar-menu-item sidebar-submenu-item" onclick="toggleSidebarDropdown('day48-dropdown', this)">
                        <div class="sidebar-item-content"><i class="material-symbols-rounded">add_circle</i>Day 4-8</div>
                        <i class="material-symbols-rounded dropdown-arrow">expand_more</i>
                    </button>
                    <div id="day48-dropdown" class="sidebar-dropdown-container">
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="4" data-type="prob"><i class="material-symbols-rounded">counter_4</i>Day 4 Prob.</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="5" data-type="prob"><i class="material-symbols-rounded">counter_5</i>Day 5 Prob.</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="6" data-type="prob"><i class="material-symbols-rounded">counter_6</i>Day 6 Prob.</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="7" data-type="prob"><i class="material-symbols-rounded">counter_7</i>Day 7 Prob.</button>
                        <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="8" data-type="prob"><i class="material-symbols-rounded">counter_8</i>Day 8 Prob.</button>
                    </div>
                    
                    <button class="sidebar-menu-item sidebar-submenu-item outlook-type" data-day="none" data-type="none">
                        <div class="sidebar-item-content">
                            <i class="material-symbols-rounded">cancel</i>None
                        </div>
                    </button>
                </div>
            </div>

            <button id="sidebar-mosaic-btn" class="sidebar-menu-item">
                <div class="sidebar-item-content"><i class="material-symbols-rounded">radar</i>Mosaic</div>
            </button>
            
            <button id="sidebar-alerts-btn" class="sidebar-menu-item">
                <div class="sidebar-item-content"><i class="material-symbols-rounded">warning</i>Alerts</div>
            </button>
            
            <button id="sidebar-sites-btn" class="sidebar-menu-item">
                <div class="sidebar-item-content"><i class="material-symbols-rounded">location_on</i>Sites</div>
            </button>
            
            <button id="sidebar-settings-btn" class="sidebar-menu-item">
                <div class="sidebar-item-content"><i class="material-symbols-rounded">settings</i>Settings</div>
            </button>

            <button class="sidebar-menu-item" onclick="toggleSidebarDropdown('advanced-dropdown', this)">
                <div class="sidebar-item-content">
                    <i class="material-symbols-rounded">terminal</i>
                    Advanced
                </div>
                <i class="material-symbols-rounded dropdown-arrow">expand_more</i>
            </button>
            <div id="advanced-dropdown" class="sidebar-dropdown-container">
                <button id="sidebar-debug-btn" class="sidebar-menu-item sidebar-submenu-item">
                    <div class="sidebar-item-content"><i class="material-symbols-rounded">bug_report</i>Debug File</div>
                </button>
            </div>
            <input type="file" id="debug-file-input" accept=".json, .geojson" style="display: none;">

        </div>
    </div>

    <div id="settings-overlay">
        <div class="settings-popup">
            <button class="maplibregl-popup-close-button" type="button" aria-label="Close" aria-hidden="true">×</button>
            <h4>Settings</h4>
            
            <div class="settings-content-wrapper">
                <div class="settings-category-header">Map</div>
                <div class="settings-splitter"></div>
                
                <button class="settings-item" onclick="toggleSidebarDropdown('site-selection-dropdown', this)">
                    <div class="sidebar-item-content">
                        <i class="material-symbols-rounded">my_location</i>
                        Site Selection
                    </div>
                    <i class="material-symbols-rounded dropdown-arrow">expand_more</i>
                </button>
                <div id="site-selection-dropdown" class="sidebar-dropdown-container">
                    <button class="sidebar-menu-item sidebar-submenu-item site-select-option" data-value="Both">
                        <div class="sidebar-item-content">Both</div>
                    </button>
                    <button class="sidebar-menu-item sidebar-submenu-item site-select-option" data-value="WSR-88D">
                        <div class="sidebar-item-content">WSR-88D</div>
                    </button>
                    <button class="sidebar-menu-item sidebar-submenu-item site-select-option" data-value="TDWR">
                        <div class="sidebar-item-content">TDWR</div>
                    </button>
                </div>

                <div class="settings-category-header">App</div>
                <div class="settings-splitter"></div>
                
                <button class="settings-item" id="save-settings-btn">
                    <div class="sidebar-item-content">
                        <i class="material-symbols-rounded">save</i>
                        Save Settings
                    </div>
                    <div class="toggle-switch-ui" id="save-settings-toggle-ui"></div>
                </button>
                
            </div>
        </div>
    </div>

    <div style="display: none;">
        <input type="checkbox" id="radar-toggle" checked>
        <input type="checkbox" id="alerts-toggle" checked>
        <input type="checkbox" id="radar-sites-toggle" checked>
    </div>
    
    <script>
        function disableContextMenu(event) {
            event.stopPropagation();
            event.preventDefault();
        }
        
        function toggleSidebarDropdown(id, btnElement) {
            const dropdown = document.getElementById(id);
            if (dropdown) {
                dropdown.classList.toggle('show');
                btnElement.classList.toggle('active');
            }
        }
        
        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerText = message;
            container.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 1000);
        }

        let radarSiteSelectionMode = 'Both'; 
        let activeSpcDay = 'none';
        let activeSpcType = 'none';
        let activeSiteIdForData = null;
        let activeRadarProductCode = null;

        document.addEventListener('DOMContentLoaded', () => {
            const saveSettingsBtn = document.getElementById('save-settings-btn');
            const saveSettingsToggleUI = document.getElementById('save-settings-toggle-ui');
            const radarToggle = document.getElementById('radar-toggle');
            const alertsToggle = document.getElementById('alerts-toggle');
            const sitesToggle = document.getElementById('radar-sites-toggle');

            const savedSettingsState = localStorage.getItem('saveSettings');
            if (savedSettingsState === 'true') {
                saveSettingsToggleUI.classList.add('active');
                if (localStorage.getItem('radarVisible') === 'false') radarToggle.checked = false;
                if (localStorage.getItem('alertsVisible') === 'false') alertsToggle.checked = false;
                if (localStorage.getItem('sitesVisible') === 'false') sitesToggle.checked = false;
                activeSpcDay = localStorage.getItem('activeSpcDay') || 'none';
                activeSpcType = localStorage.getItem('activeSpcType') || 'none';
                activeSiteIdForData = localStorage.getItem('activeSiteId');
                activeRadarProductCode = localStorage.getItem('activeProduct');
                radarSiteSelectionMode = localStorage.getItem('siteSelection') || 'Both';
            }

            function saveCurrentState() {
                if (localStorage.getItem('saveSettings') === 'true') {
                    localStorage.setItem('radarVisible', radarToggle.checked);
                    localStorage.setItem('alertsVisible', alertsToggle.checked);
                    localStorage.setItem('sitesVisible', sitesToggle.checked);
                    localStorage.setItem('activeSpcDay', activeSpcDay);
                    localStorage.setItem('activeSpcType', activeSpcType);
                    localStorage.setItem('activeSiteId', activeSiteIdForData || "");
                    localStorage.setItem('activeProduct', activeRadarProductCode || "");
                    localStorage.setItem('siteSelection', radarSiteSelectionMode);
                }
            }

            saveSettingsBtn.addEventListener('click', () => {
                const isActive = saveSettingsToggleUI.classList.contains('active');
                if (isActive) {
                    saveSettingsToggleUI.classList.remove('active');
                    localStorage.clear();
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });
                    location.reload(); 
                } else {
                    saveSettingsToggleUI.classList.add('active');
                    localStorage.setItem('saveSettings', 'true');
                    saveCurrentState();
                    showToast("Settings Saved");
                }
            });

            document.getElementById('alert-popup-container').addEventListener('contextmenu', disableContextMenu);
            document.getElementById('attribution-bubble').addEventListener('contextmenu', disableContextMenu);
            
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const menuBtn = document.getElementById('pill-menu-btn');
            const closeBtn = document.getElementById('sidebar-close-btn');
            const sbSettingsBtn = document.getElementById('sidebar-settings-btn');
            const sbMosaicBtn = document.getElementById('sidebar-mosaic-btn');
            const sbAlertsBtn = document.getElementById('sidebar-alerts-btn');
            const sbSitesBtn = document.getElementById('sidebar-sites-btn');
            const sbDebugBtn = document.getElementById('sidebar-debug-btn');
            const debugInput = document.getElementById('debug-file-input');
            const settingsOverlay = document.getElementById('settings-overlay');
            const settingsCloseBtn = settingsOverlay.querySelector('.maplibregl-popup-close-button');
            const pillInfoBtn = document.getElementById('pill-info-btn');

            sidebar.addEventListener('contextmenu', disableContextMenu);
            menuBtn.addEventListener('contextmenu', disableContextMenu);

            function openSidebar() {
                sidebar.classList.add('open');
                sidebarOverlay.style.display = 'block';
            }

            function closeSidebar() {
                sidebar.classList.remove('open');
                sidebarOverlay.style.display = 'none';
                document.querySelectorAll('.sidebar-dropdown-container.show').forEach(el => { el.classList.remove('show'); });
                document.querySelectorAll('.sidebar-menu-item.active').forEach(el => { el.classList.remove('active'); });
                document.querySelectorAll('.settings-item.active').forEach(el => { el.classList.remove('active'); });
            }

            menuBtn.addEventListener('click', (e) => { e.stopPropagation(); openSidebar(); });
            closeBtn.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);
            
            sbMosaicBtn.addEventListener('click', () => {
                radarToggle.checked = !radarToggle.checked;
                updateMosaicVisibility();
                saveCurrentState();
            });
            
            sbAlertsBtn.addEventListener('click', () => {
                const newState = !alertsToggle.checked;
                alertsToggle.checked = newState;
                const v = newState ? 'visible' : 'none';
                const alertLayers = [layerIds.alertsZone, layerIds.alertsZoneBorder, layerIds.alertsPolygon, layerIds.alertsPolygonBorder];
                alertLayers.forEach(layerId => { if (map.getLayer(layerId)) map.setLayoutProperty(layerId, 'visibility', v); });
                saveCurrentState();
            });
            
            sbSitesBtn.addEventListener('click', () => {
                sitesToggle.checked = !sitesToggle.checked;
                if (map.getLayer(layerIds.radarSites)) map.setLayoutProperty(layerIds.radarSites, 'visibility', sitesToggle.checked ? 'visible' : 'none');
                saveCurrentState();
            });
            
            sbSettingsBtn.addEventListener('click', () => { closeSidebar(); settingsOverlay.style.display = 'flex'; });
            settingsCloseBtn.addEventListener('click', () => { settingsOverlay.style.display = 'none'; });
            settingsOverlay.addEventListener('click', (e) => { if (e.target === settingsOverlay) settingsOverlay.style.display = 'none'; });
            
            const siteSelectOptions = document.querySelectorAll('.site-select-option');
            siteSelectOptions.forEach(opt => { if(opt.dataset.value === radarSiteSelectionMode) opt.style.background = 'rgba(255, 255, 255, 0.2)'; });
            siteSelectOptions.forEach(option => {
                option.addEventListener('click', () => {
                    radarSiteSelectionMode = option.dataset.value;
                    showToast(`Site Selection: ${radarSiteSelectionMode}`);
                    siteSelectOptions.forEach(opt => opt.style.background = 'transparent');
                    option.style.background = 'rgba(255, 255, 255, 0.2)';
                    saveCurrentState();
                });
            });
            
            const sidebarOutlookBtns = document.querySelectorAll('.sidebar-menu-item.outlook-type');
            sidebarOutlookBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    activeSpcDay = btn.dataset.day;
                    activeSpcType = btn.dataset.type;
                    updateSpcLayerVisibility();
                    saveCurrentState();
                    closeSidebar(); 
                });
            });
            
            sbDebugBtn.addEventListener('click', () => { debugInput.click(); closeSidebar(); });
            debugInput.addEventListener('change', handleDebugUpload);
            pillInfoBtn.addEventListener('click', () => {
                if (!activeSiteIdForData || !activeRadarProductCode) return;
                const siteData = allRadarSitesData.find(site => site.properties.id.toLowerCase() === activeSiteIdForData);
                if (!siteData) return;
                const stationType = siteData.properties.stationType;
                let newProduct = null;
                if (['sr_bref', 'bref1', 'brefl'].includes(activeRadarProductCode)) { newProduct = (stationType === 'TDWR') ? 'bvel' : 'sr_bvel'; }
                else { newProduct = (stationType === 'TDWR') ? 'bref1' : 'sr_bref'; }
                if (newProduct) toggleRadarProduct(activeSiteIdForData, newProduct);
            });

            const fullAlertOverlay = document.createElement('div');
            fullAlertOverlay.id = 'full-alert-text-popup-overlay';
            fullAlertOverlay.innerHTML = `
                <div id="full-alert-text-popup">
                    <button class="maplibregl-popup-close-button" type="button" aria-label="Close popup" aria-hidden="true">×</button>
                    <div id="full-alert-text-content"></div>
                </div>
            `;
            document.body.appendChild(fullAlertOverlay);
            fullAlertOverlay.addEventListener('contextmenu', disableContextMenu);
            fullAlertOverlay.style.display = 'none'; 
            document.querySelector('#full-alert-text-popup .maplibregl-popup-close-button').addEventListener('click', () => { fullAlertOverlay.style.display = 'none'; });
            fullAlertOverlay.addEventListener('click', (e) => { if (e.target === fullAlertOverlay) fullAlertOverlay.style.display = 'none'; });
            const attributionBubble = document.getElementById('attribution-bubble');
            attributionBubble.addEventListener('click', (event) => { event.stopPropagation(); attributionBubble.classList.toggle('expanded'); });

            window.saveCurrentState = saveCurrentState;
        });

        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
            center: [-97, 39],
            zoom: 3,
            attributionControl: false
        });

        const layerIds = {
            radar: 'weather-radar-layer',
            alertsZone: 'alerts-zone-layer',
            alertsZoneBorder: 'alerts-zone-border-layer',
            alertsPolygon: 'alerts-polygon-layer',
            alertsPolygonBorder: 'alerts-polygon-border-layer',
            radarSites: 'nws-radar-sites-layer',
            singleSiteRadar: 'single-site-radar-layer',
            spc: {
                day1: { cat: 'spc-day1-cat', torn: 'spc-day1-torn', hail: 'spc-day1-hail', wind: 'spc-day1-wind' },
                day2: { cat: 'spc-day2-cat', torn: 'spc-day2-torn', hail: 'spc-day2-hail', wind: 'spc-day2-wind' },
                day3: { cat: 'spc-day3-cat', prob: 'spc-day3-prob' },
                day4: { prob: 'spc-day4-prob' },
                day5: { prob: 'spc-day5-prob' },
                day6: { prob: 'spc-day6-prob' },
                day7: { prob: 'spc-day7-prob' },
                day8: { prob: 'spc-day8-prob' }
            }
        };
        
        let countyDataMap = new Map();
        let ugcGeoCache = new Map();
        let activeSiteIdForMenu = null;
        let currentMapPopup = null; 
        let allRadarSitesData = []; 
        let currentStackedAlertsOnMap = []; 
        let currentStackedAlertIndex = 0;
        let globalPolyAlerts = [];
        let globalZoneAlerts = [];
        let alertQueue = [], seenAlerts = new Set(), isDisplayingAlert = false, isInitialLoad = true;
        let activeAlertFlashes = new Map();
        let updateIntervalId = null;
        const baseSpcLayerIds = Object.values(layerIds.spc).flatMap(day => Object.values(day));
        const allSpcLayerIds = baseSpcLayerIds.flatMap(id => [id, `${id}-border`]);
        const spcSources = [
            { id: layerIds.spc.day1.cat, url: 'https://www.spc.noaa.gov/products/outlook/day1otlk_cat.nolyr.geojson' }, { id: layerIds.spc.day1.torn, url: 'https://www.spc.noaa.gov/products/outlook/day1otlk_torn.nolyr.geojson' }, { id: layerIds.spc.day1.hail, url: 'https://www.spc.noaa.gov/products/outlook/day1otlk_hail.nolyr.geojson' }, { id: layerIds.spc.day1.wind, url: 'https://www.spc.noaa.gov/products/outlook/day1otlk_wind.nolyr.geojson' },
            { id: layerIds.spc.day2.cat, url: 'https://www.spc.noaa.gov/products/outlook/day2otlk_cat.nolyr.geojson' }, { id: layerIds.spc.day2.torn, url: 'https://www.spc.noaa.gov/products/outlook/day2otlk_torn.nolyr.geojson' }, { id: layerIds.spc.day2.hail, url: 'https://www.spc.noaa.gov/products/outlook/day2otlk_hail.nolyr.geojson' }, { id: layerIds.spc.day2.wind, url: 'https://www.spc.noaa.gov/products/outlook/day2otlk_wind.nolyr.geojson' },
            { id: layerIds.spc.day3.cat, url: 'https://www.spc.noaa.gov/products/outlook/day3otlk_cat.nolyr.geojson' }, { id: layerIds.spc.day3.prob, url: 'https://www.spc.noaa.gov/products/outlook/day3otlk_prob.nolyr.geojson' },
            { id: layerIds.spc.day4.prob, url: 'https://www.spc.noaa.gov/products/exper/day4-8/day4prob.nolyr.geojson' },
            { id: layerIds.spc.day5.prob, url: 'https://www.spc.noaa.gov/products/exper/day4-8/day5prob.nolyr.geojson' },
            { id: layerIds.spc.day6.prob, url: 'https://www.spc.noaa.gov/products/exper/day4-8/day6prob.nolyr.geojson' },
            { id: layerIds.spc.day7.prob, url: 'https://www.spc.noaa.gov/products/exper/day4-8/day7prob.nolyr.geojson' },
            { id: layerIds.spc.day8.prob, url: 'https://www.spc.noaa.gov/products/exper/day4-8/day8prob.nolyr.geojson' }
        ];

        const alertColorMap = { 'Tornado Warning': '#FF0000', 'Tornado Watch': '#FFFF00', 'Severe Thunderstorm Warning': '#FFA500', 'Severe Thunderstorm Watch': '#DB7093', 'Flash Flood Warning': '#8B0000', 'Flash Flood Statement': '#8B0000', 'Flash Flood Watch': '#2E8B57', 'Flood Warning': '#00FF00', 'Flood Statement': '#00FF00', 'Flood Watch': '#2E8B57', 'Flood Advisory': '#00FF7F', 'Special Marine Warning': '#FFA500', 'Marine Weather Statement': '#FFDAB9', 'Special Weather Statement': '#FFE4B5', 'Storm Warning': '#9400D3', 'Storm Watch': '#FFE4B5', 'Winter Storm Warning': '#FF69B4', 'Winter Storm Watch': '#4682B4', 'Winter Weather Advisory': '#7B68EE', 'Blizzard Warning': '#FF4500', 'Blizzard Watch': '#ADFF2F', 'Ice Storm Warning': '#8B008B', 'Snow Squall Warning': '#C71585', 'High Wind Warning': '#DAA520', 'High Wind Watch': '#B8860B', 'Wind Advisory': '#D2B48C', 'Gale Warning': '#DDA0DD', 'Gale Watch': '#FFC0CB', 'Hurricane Warning': '#DC143C', 'Hurricane Watch': '#FF00FF', 'Tropical Storm Warning': '#B22222', 'Tropical Storm Watch': '#F08080', 'Red Flag Warning': '#FF1493', 'Fire Weather Watch': '#FFDEAD', 'Heat Advisory': '#FF7F50', 'Excessive Heat Warning': '#C71585', 'Excessive Heat Watch': '#800000', 'Freeze Warning': '#483D8B', 'Freeze Watch': '#00FFFF', 'Frost Advisory': '#6495ED', 'Dense Fog Advisory': '#708090', 'Air Quality Alert': '#808080', 'Dust Storm Warning': '#FF8C00', 'Blowing Dust Warning': '#FF8C00', 'Blowing Dust Advisory': '#BDB76B', 'Small Craft Advisory': '#D8BFD8', 'Hazardous Seas Warning': '#D8BFD8', 'Hazardous Seas Watch': '#483D8B', 'Lake Wind Advisory': '#D2B48C', 'Beach Hazards Statement': '#40E0D0', 'Coastal Flood Warning': '#228B22', 'Coastal Flood Watch': '#66CDAA', 'Coastal Flood Advisory': '#7CFC00', 'Tsunami Warning': '#FD6347', 'Tsunami Watch': '#FF00FF', 'Tsunami Advisory': '#D2691E', 'Civil Emergency Message': '#FFB6C1', 'Law Enforcement Warning': '#C0C0C0', 'Shelter In Place Warning': '#FA8072', 'Evacuation - Immediate': '#7FFF00', '911 Telephone Outage': '#C0C0C0', 'Administrative Message': '#FFFFFF', 'Child Abduction Emergency': '#FFFFFF', 'Extreme Wind Warning': '#FF8C00', 'Test': '#F0F8FF' };
        function hexToRgba(hex, alpha) { if (!hex) return `rgba(128, 128, 128, ${alpha})`; const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16); return `rgba(${r}, ${g}, ${b}, ${alpha})`; }
        function parseApiDate(dateString) { return new Date(dateString); }
        function getSpecificAlertName(props) {
            const event = props.event;
            const params = props.parameters || {};
            if (event === 'Tornado Warning') {
                const threat = params.tornadoDamageThreat?.[0];
                if (threat === 'CATASTROPHIC') return 'Catastrophic Tornado';
                if (threat === 'CONSIDERABLE') return 'Considerable Tornado';
                if (params.tornadoDetection?.[0] === 'OBSERVED') return 'Confirmed Tornado';
            }
            if (event === 'Severe Thunderstorm Warning') {
                const threat = params.thunderstormDamageThreat?.[0];
                if (threat === 'DESTRUCTIVE') return 'Destructive Thunderstorm';
                if (threat === 'CONSIDERABLE') return 'Considerable Thunderstorm';
                if (params.tornadoDetection?.[0] === 'POSSIBLE') return 'Tornado Possible';
            }
            if (event === 'Special Marine Warning' || event === 'Marine Weather Statement') {
                 const threat = params.waterspoutDetection?.[0];
                 if (threat === 'OBSERVED') return 'Confirmed Waterspout';
                 if (threat === 'POSSIBLE') return 'Waterspout Possible';
            }
            if (event === 'Flash Flood Warning') {
                const threat = params.flashFloodDamageThreat?.[0];
                if (threat === 'CATASTROPHIC') return 'Catastrophic Flash Flood';
                if (threat === 'CONSIDERABLE') return 'Considerable Flash Flood';
            }
            return event;
        }
        function isValidAlert(feature) {
            const props = feature.properties;
            if (!props) return false;
            if (props.parameters && props.parameters.VTEC && props.parameters.VTEC[0] && props.parameters.VTEC[0].startsWith("/O.CAN.")) return false;
            return true;
        }
        function formatThreatValue(value) {
            if (!value || typeof value !== 'string') return '';
            const cleanedValue = value.toUpperCase() === 'N/A' ? '' : value;
            if (!cleanedValue) return '';
            return cleanedValue.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }
        function flashAlertOnMap(feature, duration = 10000) {
            if (!feature || !feature.geometry || !feature.properties || !feature.properties.id) return;
            const alertId = feature.properties.id;
            const now = Date.now();
            const existingFlash = activeAlertFlashes.get(alertId);
            if (existingFlash) {
                const remainingTime = existingFlash.endTime - now;
                if (remainingTime > 3000) return;
                else {
                    clearTimeout(existingFlash.timeoutId);
                    if (map.getLayer(existingFlash.borderHighlightId)) map.removeLayer(existingFlash.borderHighlightId);
                    if (map.getLayer(existingFlash.highlightId)) map.removeLayer(existingFlash.highlightId);
                    if (map.getSource(existingFlash.highlightId)) map.removeSource(existingFlash.highlightId);
                    activeAlertFlashes.delete(alertId);
                }
            }
            const highlightId = 'highlight-' + alertId + '-' + now;
            const borderHighlightId = highlightId + '-border';
            map.addSource(highlightId, { 'type': 'geojson', 'data': feature });
            map.addLayer({ 'id': highlightId, 'type': 'fill', 'source': highlightId, 'paint': { 'fill-color': '#ffffff', 'fill-opacity': 0, 'fill-opacity-transition': { duration: 450 } } });
            map.addLayer({ 'id': borderHighlightId, 'type': 'line', 'source': highlightId, 'paint': { 'line-color': '#ffffff', 'line-width': 2, 'line-opacity': 0, 'line-opacity-transition': { duration: 450 } } });
            const setOpacity = (fillOpacity, lineOpacity) => {
                if (map.getLayer(highlightId)) map.setPaintProperty(highlightId, 'fill-opacity', fillOpacity);
                if (map.getLayer(borderHighlightId)) map.setPaintProperty(borderHighlightId, 'line-opacity', lineOpacity);
            };
            const flashCount = Math.floor(duration / 2000);
            for (let i = 0; i < flashCount; i++) {
                setTimeout(() => setOpacity(0.25, 0.9), i * 2000);
                setTimeout(() => setOpacity(0, 0), i * 2000 + 1000);
            }
            const cleanupDelay = duration + 500;
            const timeoutId = setTimeout(() => {
                if (map.getLayer(borderHighlightId)) map.removeLayer(borderHighlightId);
                if (map.getLayer(highlightId)) map.removeLayer(highlightId);
                if (map.getSource(highlightId)) map.removeSource(highlightId);
                activeAlertFlashes.delete(alertId);
            }, cleanupDelay);
            activeAlertFlashes.set(alertId, { timeoutId: timeoutId, endTime: now + cleanupDelay, highlightId: highlightId, borderHighlightId: borderHighlightId });
        }
        function flyToAlert(feature) {
            if (!feature || !feature.geometry || !feature.geometry.coordinates) return;
            const bounds = new maplibregl.LngLatBounds();
            try {
                const processCoords = (coords) => {
                    for(const coord of coords) { if (Array.isArray(coord[0])) processCoords(coord); else bounds.extend(coord); }
                };
                processCoords(feature.geometry.coordinates);
                if (bounds.getNorthEast() && bounds.getSouthWest()) {
                    map.fitBounds(bounds, { padding: 150, essential: true });
                    map.once('moveend', () => flashAlertOnMap(feature, 6000));
                }
            } catch(e) { console.error(e); }
        }
        function createAndShowAlertPopup(feature, source) {
            const props = feature.properties;
            const params = props.parameters || {};
            const container = document.getElementById('alert-popup-container');
            const popup = document.createElement('div');
            popup.className = 'alert-popup';
            popup.addEventListener('contextmenu', disableContextMenu);
            const specificAlertName = props.specificEventName;
            const baseEvent = props.event;
            const accentColor = alertColorMap[baseEvent] || '#808080';
            let title = (source === 'new' && props.messageType === 'Update' ? 'Updated - ' : '') + specificAlertName;
            let detailsHTML = '<div>';
            const expireDate = parseApiDate(props.expires);
            if (expireDate && !isNaN(expireDate.getTime())) {
                const dateOptions = { timeZone: 'America/Chicago', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true };
                detailsHTML += `<p><strong>Expires:</strong> ${expireDate.toLocaleString('en-US', dateOptions)}</p>`;
            }
            if (props.areaDesc && props.areaDesc.toUpperCase() !== 'N/A') detailsHTML += `<p><strong>Affected:</strong> ${props.areaDesc}</p>`;
            const tornado = params.tornadoDetection ? params.tornadoDetection[0] : null;
            if (tornado && formatThreatValue(tornado)) detailsHTML += `<p><strong>Tornado:</strong> ${formatThreatValue(tornado)}</p>`;
            const waterspout = params.waterspoutDetection ? params.waterspoutDetection[0] : null;
            if (waterspout && formatThreatValue(waterspout)) detailsHTML += `<p><strong>Waterspout:</strong> ${formatThreatValue(waterspout)}</p>`;
            const damageThreat = params.tornadoDamageThreat?.[0] || params.thunderstormDamageThreat?.[0] || params.flashFloodDamageThreat?.[0];
            if (damageThreat && formatThreatValue(damageThreat)) detailsHTML += `<p><strong>Threat:</strong> ${formatThreatValue(damageThreat)}</p>`;
            const windGust = params.maxWindGust ? params.maxWindGust[0] : null;
            if (windGust && windGust !== '0 MPH' && formatThreatValue(windGust)) {
                const windThreat = params.windThreat ? params.windThreat[0] : null;
                let windText = windGust.replace("MPH", "mph");
                if (windThreat && formatThreatValue(windThreat)) windText += `, ${formatThreatValue(windThreat)}`;
                detailsHTML += `<p><strong>Winds:</strong> ${windText}</p>`;
            }
            const hailSize = params.maxHailSize ? params.maxHailSize[0] : null;
            if (hailSize && hailSize !== '0.00' && formatThreatValue(hailSize)) {
                const hailThreat = params.hailThreat ? params.hailThreat[0] : null;
                let hailText = hailSize + '"';
                if (hailThreat && formatThreatValue(hailThreat)) hailText += `, ${formatThreatValue(hailThreat)}`;
                detailsHTML += `<p><strong>Hail:</strong> ${hailText}</p>`;
            }
            const flashFloodDetection = params.flashFloodDetection ? params.flashFloodDetection[0] : null;
            if (flashFloodDetection && formatThreatValue(flashFloodDetection)) detailsHTML += `<p><strong>Source:</strong> ${formatThreatValue(flashFloodDetection)}</p>`;
            detailsHTML += '</div>';
            popup.style.borderLeft = `5px solid ${hexToRgba(accentColor, 0.5)}`; 
            popup.innerHTML = `<h4>${title}</h4>${detailsHTML}`;
            popup.addEventListener('click', () => flyToAlert(feature));
            container.appendChild(popup);
            setTimeout(() => popup.classList.add('fly-in'), 10);
            setTimeout(() => { popup.classList.remove('fly-in'); popup.classList.add('fly-out'); }, 7000);
            setTimeout(() => { popup.remove(); if (source === 'new') { setTimeout(() => { isDisplayingAlert = false; displayNextAlert(); }, 1000); } }, 7500);
        }
        function displayNextAlert() {
            if (isDisplayingAlert || alertQueue.length === 0) return;
            isDisplayingAlert = true;
            const { feature } = alertQueue.shift();
            flashAlertOnMap(feature, 10000);
            createAndShowAlertPopup(feature, 'new');
        }
        function addNewAlertsToQueue(features, type) {
            if (!features) return;
            features.forEach(feature => {
                const props = feature.properties;
                const id = props.id;
                if (!seenAlerts.has(id)) {
                    seenAlerts.add(id);
                    if (!isInitialLoad) alertQueue.push({ feature, type });
                }
            });
            if (!isInitialLoad) displayNextAlert();
        }
        async function processRawAlertFeatures(rawFeatures) {
            const validFeatures = rawFeatures.filter(isValidAlert);
            const polyFeatures = [];
            const zoneFeatures = [];
            validFeatures.forEach(feature => {
                feature.properties.specificEventName = getSpecificAlertName(feature.properties);
                if (feature.geometry) { feature.properties.geometryType = 'polygon'; polyFeatures.push(feature); }
                else zoneFeatures.push(feature);
            });
            if (map.getSource('alerts-poly')) map.getSource('alerts-poly').setData({ type: 'FeatureCollection', features: polyFeatures });
            globalPolyAlerts = polyFeatures; 
            addNewAlertsToQueue(polyFeatures, 'alert');
            await processZoneAlerts(zoneFeatures);
        }
        function handleDebugUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (!data.features) throw new Error("No features found.");
                    if (updateIntervalId) clearInterval(updateIntervalId);
                    isInitialLoad = false;
                    data.features.forEach(feature => { if (!feature.properties.id) feature.properties.id = "debug_" + Math.random().toString(36).substr(2, 9); });
                    await processRawAlertFeatures(data.features);
                    const firstPoly = data.features.find(f => f.geometry);
                    if (firstPoly) flyToAlert(firstPoly);
                } catch (err) { alert("Error parsing GeoJSON file."); }
            };
            reader.readAsText(file);
        }
        function updateMosaicVisibility() {
            const mosaicToggle = document.getElementById('radar-toggle');
            const isMosaicEnabledByUser = mosaicToggle.checked;
            const isSiteRadarActive = map.getLayer(layerIds.singleSiteRadar);
            if (map.getLayer(layerIds.radar)) {
                if (isSiteRadarActive) map.setLayoutProperty(layerIds.radar, 'visibility', 'none');
                else map.setLayoutProperty(layerIds.radar, 'visibility', isMosaicEnabledByUser ? 'visible' : 'none');
            }
        }
        function removeSingleSiteLayer() {
            if (map.getLayer(layerIds.singleSiteRadar)) map.removeLayer(layerIds.singleSiteRadar);
            if (map.getSource('single-site-radar-source')) map.removeSource('single-site-radar-source');
            document.getElementById('radar-info-pill').style.display = 'none';
        }
        function closeAllPopups() {
            const maplibrePopups = document.querySelectorAll('.maplibregl-popup');
            maplibrePopups.forEach(popup => popup.remove());
            activeSiteIdForMenu = null;
            currentMapPopup = null; 
            currentStackedAlertsOnMap = [];
            currentStackedAlertIndex = 0;
            document.getElementById('full-alert-text-popup-overlay').style.display = 'none';
        }
        function toggleRadarProduct(stationId, productCode) {
            const isTogglingOff = activeSiteIdForData === stationId && activeRadarProductCode === productCode;
            removeSingleSiteLayer();
            if (isTogglingOff) {
                activeRadarProductCode = null;
                activeSiteIdForData = null;
                map.setPaintProperty(layerIds.radarSites, 'circle-color', ['case', ['==', ['get', 'isOffline'], true], '#ff0000', ['==', ['get', 'stationType'], 'WSR-88D'], '#0099ff', ['==', ['get', 'stationType'], 'TDWR'], '#ff9900', '#808080']);
            } else {
                activeRadarProductCode = productCode;
                activeSiteIdForData = stationId;
                const tileUrl = `https://opengeo.ncep.noaa.gov/geoserver/${stationId}/ows?service=WMS&version=1.3.0&request=GetMap&layers=${stationId}_${productCode}&styles=&format=image/png&transparent=true&width=256&height=256&crs=EPSG:3857&bbox={bbox-epsg-3857}&_=${new Date().getTime()}`;
                map.addSource('single-site-radar-source', { 'type': 'raster', 'tiles': [tileUrl], 'tileSize': 256, 'attribution': 'Radar data from NOAA' });
                map.addLayer({ 'id': layerIds.singleSiteRadar, 'type': 'raster', 'source': 'single-site-radar-source', 'paint': {} }, layerIds.alertsZone); 
                map.setPaintProperty(layerIds.radarSites, 'circle-color', ['case', ['==', ['get', 'id'], stationId.toUpperCase()], '#00ff00', ['==', ['get', 'isOffline'], true], '#ff0000', ['==', ['get', 'stationType'], 'WSR-88D'], '#0099ff', ['==', ['get', 'stationType'], 'TDWR'], '#ff9900', '#808080']);
                updateRadarPillUI(stationId, productCode);
            }
            updateMosaicVisibility();
            if (window.saveCurrentState) window.saveCurrentState();
        }
        function updateRadarPillUI(stationId, productCode) {
            const pillIdTime = document.getElementById('pill-id-time');
            const pillProduct = document.getElementById('pill-product');
            pillIdTime.innerText = stationId.toUpperCase();
            let productLabel = (['sr_bvel', 'bvel'].includes(productCode)) ? "Velocity" : "Reflectivity";
            pillProduct.innerText = productLabel;
            document.getElementById('radar-info-pill').style.display = 'flex';
        }
        async function updateAlerts() {
            try {
                const response = await fetch('https://api.weather.gov/alerts/active?status=actual&message_type=alert,update');
                if (!response.ok) throw new Error();
                const data = await response.json();
                await processRawAlertFeatures(data.features);
                if (isInitialLoad) isInitialLoad = false;
            } catch (e) {}
        }
        async function processZoneAlerts(featuresToProcess) {
            const promises = featuresToProcess.map(async (feature) => {
                const props = feature.properties;
                let alertGeometries = [];
                if (props.geocode && props.geocode.UGC && props.geocode.UGC.length > 0) {
                    for (const ugcCode of props.geocode.UGC) {
                        if (ugcGeoCache.has(ugcCode)) {
                            const cachedGeo = ugcGeoCache.get(ugcCode);
                            if (cachedGeo) {
                                if (cachedGeo.type === 'Polygon') alertGeometries.push(cachedGeo.coordinates);
                                else if (cachedGeo.type === 'MultiPolygon') alertGeometries.push(...cachedGeo.coordinates);
                            }
                            continue;
                        }
                        const type = ugcCode.charAt(2).toUpperCase() === 'C' ? 'county' : 'forecast';
                        try {
                            const zoneResponse = await fetch(`https://api.weather.gov/zones/${type}/${ugcCode}`);
                            const zoneData = await zoneResponse.json();
                            if (zoneData.geometry) {
                                ugcGeoCache.set(ugcCode, zoneData.geometry);
                                if (zoneData.geometry.type === 'Polygon') alertGeometries.push(zoneData.geometry.coordinates);
                                else if (zoneData.geometry.type === 'MultiPolygon') alertGeometries.push(...zoneData.geometry.coordinates);
                            } else ugcGeoCache.set(ugcCode, null);
                        } catch (error) { ugcGeoCache.set(ugcCode, null); }
                    }
                }
                if (alertGeometries.length === 0 && props.geocode && props.geocode.SAME) {
                    props.geocode.SAME.forEach(fipsCode => {
                        const countyFeature = countyDataMap.get(fipsCode.substring(1));
                        if (countyFeature && countyFeature.geometry) {
                            if (countyFeature.geometry.type === 'Polygon') alertGeometries.push(countyFeature.geometry.coordinates);
                            else if (countyFeature.geometry.type === 'MultiPolygon') alertGeometries.push(...countyFeature.geometry.coordinates);
                        }
                    });
                }
                if (alertGeometries.length > 0) return { type: 'Feature', geometry: { type: 'MultiPolygon', coordinates: alertGeometries }, properties: { ...props, geometryType: 'zone' } };
                return null;
            });
            const resolvedFeatures = (await Promise.all(promises)).filter(Boolean);
            if (map.getSource('alerts-zone')) map.getSource('alerts-zone').setData({ type: 'FeatureCollection', features: resolvedFeatures });
            globalZoneAlerts = resolvedFeatures; 
            addNewAlertsToQueue(resolvedFeatures, 'alert');
        }
        async function checkRadarStatus() {
            const now = Date.now();
            const twentyMinutesAgo = now - (20 * 60 * 1000); 
            let changedStatus = false;
            const updatedRadarSitesData = [...allRadarSitesData];
            for (let i = 0; i < updatedRadarSitesData.length; i++) {
                const site = updatedRadarSitesData[i];
                const radarId = site.properties.id;
                let isOffline = site.properties.isOffline; 
                try {
                    const response = await fetch(`https://api.weather.gov/radar/stations/${radarId}`);
                    const data = await response.json();
                    const levelTwoTimeStr = data.properties.latency?.levelTwoLastReceivedTime;
                    let newIsOffline = (levelTwoTimeStr) ? (new Date(levelTwoTimeStr).getTime() < twentyMinutesAgo) : true;
                    if (isOffline !== newIsOffline) { updatedRadarSitesData[i] = { ...site, properties: { ...site.properties, isOffline: newIsOffline } }; changedStatus = true; }
                } catch (error) {
                    if (!isOffline) { updatedRadarSitesData[i] = { ...site, properties: { ...site.properties, isOffline: true } }; changedStatus = true; }
                }
            }
            allRadarSitesData = updatedRadarSitesData; 
            if (changedStatus && map.getSource('radar-sites')) {
                map.getSource('radar-sites').setData({ type: 'FeatureCollection', features: allRadarSitesData });
                const siteColorExp = ['case', ['==', ['get', 'isOffline'], true], '#ff0000', ['==', ['get', 'stationType'], 'WSR-88D'], '#0099ff', ['==', ['get', 'stationType'], 'TDWR'], '#ff9900', '#808080'];
                if (activeSiteIdForData) map.setPaintProperty(layerIds.radarSites, 'circle-color', ['case', ['==', ['get', 'id'], activeSiteIdForData.toUpperCase()], '#00ff00', ...siteColorExp.slice(1)]);
                else map.setPaintProperty(layerIds.radarSites, 'circle-color', siteColorExp);
            }
        }
        async function fetchSpcOutlookText(day) {
            let url = (parseInt(day) >= 4) ? 'https://www.spc.noaa.gov/products/exper/day4-8/index.html' : `https://www.spc.noaa.gov/products/outlook/day${day}otlk.html`;
            try {
                const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                const data = await response.json();
                if (data.contents) {
                    const preTag = new DOMParser().parseFromString(data.contents, 'text/html').querySelector('pre');
                    return preTag ? preTag.textContent : "Forecast text not found.";
                }
                throw new Error();
            } catch (error) { return "Failed to load SPC forecast."; }
        }
        function updateRadar() { if (map.getSource('weather-radar')) map.getSource('weather-radar').setTiles([ `https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi?service=WMS&version=1.1.1&request=GetMap&layers=nexrad-n0q-900913&srs=EPSG:900913&width=256&height=256&format=image/png&transparent=true&bbox={bbox-epsg-3857}&_=${new Date().getTime()}` ]); }
        function updateSingleSiteRadar() { if (map.getSource('single-site-radar-source') && activeSiteIdForData && activeRadarProductCode) { const tileUrl = `https://opengeo.ncep.noaa.gov/geoserver/${activeSiteIdForData}/ows?service=WMS&version=1.3.0&request=GetMap&layers=${activeSiteIdForData}_${activeRadarProductCode}&styles=&format=image/png&transparent=true&width=256&height=256&crs=EPSG:3857&bbox={bbox-epsg-3857}&_=${new Date().getTime()}`; map.getSource('single-site-radar-source').setTiles([tileUrl]); } }
        async function updateSpcOutlooks() { for (const sourceInfo of spcSources) { if (map.getSource(sourceInfo.id)) { try { const response = await fetch(`${sourceInfo.url}?t=${new Date().getTime()}`); const geojsonData = await response.json(); map.getSource(sourceInfo.id).setData(geojsonData); } catch (e) {} } } }
        async function setupMapData() {
            if (countyDataMap.size === 0) {
                try {
                    const response = await fetch('https://raw.githubusercontent.com/12treesarecool34/treewarn/main/counties-simplified.json');
                    const allCountiesGeoJSON = await response.json();
                    allCountiesGeoJSON.features.forEach(county => countyDataMap.set(county.properties.FIPS, county));
                } catch (error) { return; }
            }
            let firstSymbolId;
            for (const layer of map.getStyle().layers) { if (layer.type === 'symbol') { firstSymbolId = layer.id; break; } }
            spcSources.forEach(source => { if (!map.getSource(source.id)) map.addSource(source.id, { type: 'geojson', data: source.url }); });
            if (!map.getSource('weather-radar')) map.addSource('weather-radar', { 'type': 'raster', 'tiles': [`https://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0q.cgi?service=WMS&version=1.1.1&request=GetMap&layers=nexrad-n0q-900913&srs=EPSG:900913&width=256&height=256&format=image/png&transparent=true&bbox={bbox-epsg-3857}&_=${new Date().getTime()}`], 'tileSize': 256 });
            if (!map.getSource('alerts-poly')) map.addSource('alerts-poly', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
            if (!map.getSource('alerts-zone')) map.addSource('alerts-zone', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
            if (allRadarSitesData.length === 0) {
                 const response = await fetch('https://api.weather.gov/radar/stations?stationType=WSR-88D,TDWR');
                 const data = await response.json();
                 allRadarSitesData = data.features.map(feature => ({ ...feature, properties: { ...feature.properties, isOffline: false } }));
            }
            if (!map.getSource('radar-sites')) map.addSource('radar-sites', { type: 'geojson', data: { type: 'FeatureCollection', features: allRadarSitesData } });
            const alertColorExpression = ['match', ['get', 'event']]; 
            for (const name in alertColorMap) alertColorExpression.push(name, alertColorMap[name]);
            alertColorExpression.push('#808080'); 
            const alertsVisible = document.getElementById('alerts-toggle').checked ? 'visible' : 'none';
            if (!map.getLayer(layerIds.alertsZone)) map.addLayer({ id: layerIds.alertsZone, type: 'fill', source: 'alerts-zone', paint: { 'fill-color': alertColorExpression, 'fill-opacity': 0.1 }, layout: { 'visibility': alertsVisible }, filter: ['==', 'geometryType', 'zone'] }, firstSymbolId);
            if (!map.getLayer(layerIds.alertsZoneBorder)) map.addLayer({ id: layerIds.alertsZoneBorder, type: 'line', source: 'alerts-zone', paint: { 'line-color': alertColorExpression, 'line-width': 1 }, layout: { 'visibility': alertsVisible }, filter: ['==', 'geometryType', 'zone'] }, firstSymbolId);
            if (!map.getLayer(layerIds.alertsPolygon)) map.addLayer({ id: layerIds.alertsPolygon, type: 'fill', source: 'alerts-poly', paint: { 'fill-color': alertColorExpression, 'fill-opacity': 0.3 }, layout: { 'visibility': alertsVisible }, filter: ['==', 'geometryType', 'polygon'] }, firstSymbolId);
            if (!map.getLayer(layerIds.alertsPolygonBorder)) map.addLayer({ id: layerIds.alertsPolygonBorder, type: 'line', source: 'alerts-poly', paint: { 'line-color': alertColorExpression, 'line-width': 2 }, layout: { 'visibility': alertsVisible }, filter: ['==', 'geometryType', 'polygon'] }, firstSymbolId);
            if (!map.getLayer(layerIds.radar)) map.addLayer({ id: layerIds.radar, type: 'raster', source: 'weather-radar', layout: { 'visibility': document.getElementById('radar-toggle').checked ? 'visible' : 'none' } }, layerIds.alertsZone); 
            spcSources.forEach(source => {
                if (!map.getLayer(source.id)) map.addLayer({ id: source.id, type: 'fill', source: source.id, paint: { 'fill-color': ['get', 'fill'], 'fill-opacity': 0.3 }, layout: { 'visibility': 'none' } }, layerIds.radar); 
                if (!map.getLayer(`${source.id}-border`)) map.addLayer({ id: `${source.id}-border`, type: 'line', source: source.id, paint: { 'line-color': ['get', 'fill'], 'line-width': 2 }, layout: { 'visibility': 'none' } }, layerIds.radar); 
            });
            if (!map.getLayer(layerIds.radarSites)) {
                map.addLayer({ id: layerIds.radarSites, type: 'circle', source: 'radar-sites', paint: { 'circle-radius': 4, 'circle-stroke-color': 'white', 'circle-stroke-width': 1.5, 'circle-color': ['case', ['==', ['get', 'isOffline'], true], '#ff0000', ['==', ['get', 'stationType'], 'WSR-88D'], '#0099ff', ['==', ['get', 'stationType'], 'TDWR'], '#ff9900', '#808080'] }, layout: { 'visibility': document.getElementById('radar-sites-toggle').checked ? 'visible' : 'none' } });
            }
        }
        function updateSpcLayerVisibility() { 
            if (!map.isStyleLoaded()) return; 
            allSpcLayerIds.forEach(id => { if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', 'none'); }); 
            if (activeSpcDay !== 'none') { 
                const layerToShow = layerIds.spc['day' + activeSpcDay][activeSpcType]; 
                if (layerToShow) { 
                    if (map.getLayer(layerToShow)) map.setLayoutProperty(layerToShow, 'visibility', 'visible'); 
                    if (map.getLayer(`${layerToShow}-border`)) map.setLayoutProperty(`${layerToShow}-border`, 'visibility', 'visible'); 
                }
            }
        }
        async function geocodeAndPlaceMarker() {
            const locationParam = new URLSearchParams(window.location.search).get('l');
            if (!locationParam) return;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(locationParam.replace(/-/g, ' '))}&format=json&limit=1`, { headers: { 'User-Agent': 'TreeRadar-WebApp' } });
                const data = await response.json();
                if (data.length > 0) {
                    const lon = parseFloat(data[0].lon), lat = parseFloat(data[0].lat);
                    new maplibregl.Marker({ color: "#FFC300", scale: 0.6 }).setLngLat([lon, lat]).addTo(map);
                    map.flyTo({ center: [lon, lat], zoom: 7, essential: true });
                }
            } catch (error) {}
        }
        function formatSpcLabel(val) {
             if (!val) return 'N/A';
             if (!isNaN(val)) return parseFloat(val) < 1 ? (parseFloat(val) * 100) + "%" : val + "%";
             const map = { 'TSTM': 'General Thunderstorms', 'MRGL': 'Marginal', 'SLGT': 'Slight', 'ENH': 'Enhanced', 'MDT': 'Moderate', 'HIGH': 'High' };
             return map[val.toUpperCase()] || val;
        }
        function showAlertMapPopup(items, clickedLngLat) {
            closeAllPopups(); currentStackedAlertsOnMap = items; currentStackedAlertIndex = 0;
            const popupDiv = document.createElement('div');
            popupDiv.className = 'map-popup-base map-alert-popup-accent-top'; 
            const updatePopupContent = () => {
                const item = currentStackedAlertsOnMap[currentStackedAlertIndex];
                if (!item) { closeAllPopups(); return; }
                const props = item.properties;
                let title, tagsHtml = '', accentColor;
                if (item.type === 'alert') {
                    const params = props.parameters || {};
                    title = props.specificEventName || props.event; accentColor = alertColorMap[props.event] || '#808080';
                    if (props.expires) tagsHtml += `<p><strong>Expires:</strong> ${new Date(props.expires).toLocaleString('en-US', { timeZone: 'America/Chicago', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true })}</p>`;
                    ['tornadoDetection', 'waterspoutDetection', 'flashFloodDetection'].forEach(k => { if (params[k]) tagsHtml += `<p><strong>${k.replace('Detection','').replace('flash','Flash ')}:</strong> ${formatThreatValue(params[k][0])}</p>`; });
                    const dmg = params.tornadoDamageThreat?.[0] || params.thunderstormDamageThreat?.[0] || params.flashFloodDamageThreat?.[0];
                    if (dmg) tagsHtml += `<p><strong>Threat:</strong> ${formatThreatValue(dmg)}</p>`;
                    if (params.maxWindGust && params.maxWindGust[0] !== '0 MPH') tagsHtml += `<p><strong>Winds:</strong> ${params.maxWindGust[0].replace("MPH", "mph")}</p>`;
                    if (params.maxHailSize && params.maxHailSize[0] !== '0.00') tagsHtml += `<p><strong>Hail:</strong> ${params.maxHailSize[0]}"</p>`;
                } else {
                    title = `SPC Day ${activeSpcDay} Outlook`; accentColor = props.fill || '#FFFFFF'; 
                    tagsHtml += `<p><strong>Risk:</strong> ${formatSpcLabel(props.LABEL || props.LABEL2)}</p>`;
                }
                popupDiv.style.borderTop = `5px solid ${hexToRgba(accentColor, 0.5)}`;
                let pager = (currentStackedAlertsOnMap.length > 1) ? `<div class="alert-pager">${currentStackedAlertsOnMap.map((_, i) => `<div class="pager-dot ${i === currentStackedAlertIndex ? 'active' : ''}" data-index="${i}"></div>`).join('')}</div>` : '';
                popupDiv.innerHTML = `<h4>${title}</h4><div class="popup-content-area">${tagsHtml}<ul><li><button id="full-text-button">Full Text</button></li></ul></div>${pager}`;
                popupDiv.querySelector('#full-text-button').onclick = () => item.type === 'alert' ? showFullAlertTextPopup(item.feature) : showFullSpcTextPopup(item);
                popupDiv.querySelectorAll('.pager-dot').forEach(d => d.onclick = (e) => { currentStackedAlertIndex = parseInt(e.target.dataset.index); updatePopupContent(); });
            };
            updatePopupContent(); 
            currentMapPopup = new maplibregl.Popup({ closeOnClick: true, closeButton: false, anchor: 'bottom', className: 'custom-map-popup-container' }).setLngLat(clickedLngLat).setDOMContent(popupDiv).addTo(map);
        }
        function showFullAlertTextPopup(feature) {
            const props = feature.properties;
            const overlay = document.getElementById('full-alert-text-popup-overlay');
            const rgba = hexToRgba(alertColorMap[props.event] || '#808080', 0.5);
            const el = document.getElementById('full-alert-text-popup');
            el.style.borderLeft = el.style.borderTop = el.style.borderRight = `5px solid ${rgba}`;
            let desc = (props.description || "").replace(/\n/g, '<br>').trim();
            let inst = (props.instruction || "").replace(/\n/g, '<br>').trim();
            document.getElementById('full-alert-text-content').innerHTML = `<h4>${props.specificEventName || props.event}</h4><p><strong>Sent:</strong> ${new Date(props.sent).toLocaleString()}</p><p><strong>Expires:</strong> ${new Date(props.expires).toLocaleString()}</p><p><strong>Affected:</strong> ${props.areaDesc}</p><p>&nbsp;</p><p><strong>Description:</strong></p><p>${desc}</p>${inst ? `<p>&nbsp;</p><p><strong>Instructions:</strong></p><p>${inst}</p>` : ''}`;
            overlay.style.display = 'flex'; 
        }
        async function showFullSpcTextPopup(item) {
            const overlay = document.getElementById('full-alert-text-popup-overlay');
            const fullAlertPopupElement = document.getElementById('full-alert-text-popup');
            const rgba = hexToRgba(item.properties.fill || '#FFFFFF', 0.5);
            fullAlertPopupElement.style.borderLeft = fullAlertPopupElement.style.borderTop = fullAlertPopupElement.style.borderRight = `5px solid ${rgba}`;
            document.getElementById('full-alert-text-content').innerHTML = `<h4>SPC Day ${activeSpcDay} Discussion</h4><p>Loading...</p>`;
            overlay.style.display = 'flex';
            const text = await fetchSpcOutlookText(activeSpcDay);
            document.getElementById('full-alert-text-content').innerHTML = `<h4>SPC Day ${activeSpcDay} Discussion</h4><pre>${text}</pre>`;
        }
        function handleOutlookShortcut(day) {
            const types = outlookTypes[day];
            if (!types) return;
            let nextType = (activeSpcDay === day) ? types[(types.indexOf(activeSpcType) + 1) % types.length] : types[0];
            activeSpcDay = day; activeSpcType = nextType;
            updateSpcLayerVisibility();
            if (window.saveCurrentState) window.saveCurrentState();
            showToast(`Outlook: Day ${day} ${typeLabels[nextType]}`);
        }
        const outlookTypes = { '1': ['cat', 'torn', 'hail', 'wind'], '2': ['cat', 'torn', 'hail', 'wind'], '3': ['cat', 'prob'], '4': ['prob'], '5': ['prob'], '6': ['prob'], '7': ['prob'], '8': ['prob'] };
        const typeLabels = { 'cat': 'Categorical', 'torn': 'Tornado', 'wind': 'Wind', 'hail': 'Hail', 'prob': 'Prob.' };
        map.on('load', async () => {
            await setupMapData(); updateSpcLayerVisibility(); geocodeAndPlaceMarker(); checkRadarStatus();
            if (activeSiteIdForData && activeRadarProductCode) {
                const s = activeSiteIdForData, p = activeRadarProductCode;
                activeSiteIdForData = activeRadarProductCode = null; toggleRadarProduct(s, p);
            }
            setInterval(checkRadarStatus, 300000); updateAlerts(); updateIntervalId = setInterval(updateAlerts, 60000); 
            setInterval(updateRadar, 60000); setInterval(updateSingleSiteRadar, 45000); setInterval(updateSpcOutlooks, 600000);
            map.on('contextmenu', (e) => {
                e.preventDefault(); closeAllPopups();
                let nearest = null, min = Infinity;
                allRadarSitesData.forEach(site => {
                    const props = site.properties;
                    if (props.isOffline) return;
                    let match = radarSiteSelectionMode === 'Both' || radarSiteSelectionMode === props.stationType;
                    if (match) {
                        const dist = e.lngLat.distanceTo(new maplibregl.LngLat(site.geometry.coordinates[0], site.geometry.coordinates[1]));
                        if (dist < min) { min = dist; nearest = site; }
                    }
                });
                if (nearest) {
                    const type = nearest.properties.stationType;
                    const id = nearest.properties.id.toLowerCase();
                    let prod = (activeRadarProductCode && (activeRadarProductCode.includes('vel'))) ? (type === 'TDWR' ? 'bvel' : 'sr_bvel') : (type === 'TDWR' ? 'bref1' : 'sr_bref');
                    map.flyTo({ center: nearest.geometry.coordinates, zoom: 7, essential: true });
                    toggleRadarProduct(id, prod);
                }
            });
        });
        map.on('click', (e) => {
            if (currentMapPopup) { closeAllPopups(); return; }
            const features = map.queryRenderedFeatures(e.point, { layers: [layerIds.radarSites, layerIds.alertsZone, layerIds.alertsPolygon, ...allSpcLayerIds] });
            closeAllPopups(); if (!features.length) return;
            const top = features[0];
            if (top.layer.id === layerIds.radarSites) {
                const site = allRadarSitesData.find(s => s.properties.id === top.properties.id);
                if (site && !site.properties.isOffline) {
                    const id = site.properties.id.toLowerCase();
                    if (activeSiteIdForData === id) { removeSingleSiteLayer(); activeRadarProductCode = activeSiteIdForData = null; updateMosaicVisibility(); if (window.saveCurrentState) window.saveCurrentState(); return; }
                    let prod = (activeRadarProductCode && activeRadarProductCode.includes('vel')) ? (site.properties.stationType === 'TDWR' ? 'bvel' : 'sr_bvel') : (site.properties.stationType === 'TDWR' ? 'bref1' : 'sr_bref');
                    toggleRadarProduct(id, prod);
                }
            } else {
                const alerts = map.queryRenderedFeatures(e.point, { layers: [layerIds.alertsZone, layerIds.alertsPolygon] }).map(f => {
                    const found = [...globalPolyAlerts, ...globalZoneAlerts].find(a => a.properties.id === f.properties.id);
                    return found ? { type: 'alert', feature: found, properties: found.properties } : null;
                }).filter(Boolean);
                const spc = activeSpcDay !== 'none' ? map.queryRenderedFeatures(e.point, { layers: allSpcLayerIds }).map(f => ({ type: 'outlook', properties: f.properties })) : [];
                const items = [...new Map(alerts.concat(spc).map(i => [i.properties.id || i.properties.LABEL, i])).values()];
                if (items.length) showAlertMapPopup(items, e.lngLat);
            }
        });
        const ptr = () => map.getCanvas().style.cursor = 'pointer', def = () => map.getCanvas().style.cursor = '';
        [layerIds.alertsZone, layerIds.alertsPolygon, layerIds.radarSites, ...allSpcLayerIds].forEach(l => { map.on('mouseenter', l, ptr); map.on('mouseleave', l, def); });
        document.addEventListener('keydown', (e) => {
            if (!e.shiftKey) return;
            const map = { 'KeyM': 'sidebar-mosaic-btn', 'KeyA': 'sidebar-alerts-btn', 'KeyS': 'sidebar-sites-btn' };
            if (map[e.code]) { document.getElementById(map[e.code]).click(); showToast(`${e.code.slice(3)} Toggle`); }
            else if (e.code === 'Backquote') { activeSpcDay = activeSpcType = 'none'; updateSpcLayerVisibility(); if (window.saveCurrentState) window.saveCurrentState(); showToast('Outlook: None'); }
            else if (e.code.startsWith('Digit')) handleOutlookShortcut(e.code.slice(5));
            if (activeSiteIdForData) {
                const site = allRadarSitesData.find(s => s.properties.id.toLowerCase() === activeSiteIdForData);
                let prod = (e.code === 'KeyR') ? (site.properties.stationType === 'TDWR' ? 'bref1' : 'sr_bref') : (e.code === 'KeyV') ? (site.properties.stationType === 'TDWR' ? 'bvel' : 'sr_bvel') : (e.code === 'KeyL' && site.properties.stationType === 'TDWR') ? 'brefl' : null;
                if (prod && prod !== activeRadarProductCode) toggleRadarProduct(activeSiteIdForData, prod);
            }
        });
    </script>
</body>
</html>
